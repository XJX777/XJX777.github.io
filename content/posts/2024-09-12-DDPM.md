+++
title = '如何理解Diffusion model，如何理解DDPM'
date = 2024-09-12T10:56:31+08:00
categories = ["AIGC", "Diffusion model"]
tags = ["AIGC", "Diffusion model", "DDPM"] 
+++

扩散模型包含两个过程，前向扩散过程（加噪）和反向生成过程（去噪）。前向扩散过程是对一张图像逐渐增加高斯噪声，直至变成图像变为随机噪声；反向生成过程将从一个随机噪声开始逐渐去噪直至生成一张图片，反向去噪过程也即图像生成过程中求解和训练的部分。下图为扩散模型与其他主流生成模型的示意图：
![扩散模型与其他主流生成模型](https://i.postimg.cc/yYNMmJcS/generative-models.png)

目前所采用的扩散模型大多基于2020年的工作DDPM: Denoising Diffusion Probabilistic Models，其对之前的扩散模型进行了简化（从预测去噪后的图片优化为预测噪声，残差思想），并较大程度上提升了扩散模型的生成效果和稳定性。同时，比扩散模型也是一个隐变量模型，可以通过变分推断来进行建模。

## 扩散模型原理
扩散模型包括两个过程，前向过程（forward process）和反向过程（reverse process），如下图所示前向过程和反向过程都是一个参数化的马尔可夫链（Markov chain）。

### 前向加噪过程
给定一个从原始数据中采样到的真实数据分布 $ x_0 \sim q(x) $，我们定义前向过程为在 T 个步骤内逐渐对数据增加少量高斯噪声，这过程中生成的一系列中间加噪结果记为 $x_1, ..., x_T$ 。

前向过程的加噪幅度大小由每一步所采用的方差控制，记为 $\beta_t$ 介于0～1之间，我们通常称不同step对应的方差设定为variance schedule或者noise schedule，通常情况下后靠后的step会采用更大的方差。随着加噪步数的增多 $x_T$ 会逐渐丢失原始数据的特征变为随机噪声，整个扩散过程也可以就是一个马尔可夫链。前向过程可表示为：

<div>
$$
q(\mathbf{x}_t|\mathbf{x}_{t-1}) = \mathcal{N}(\mathbf{x}_t; \sqrt{1 - \beta_t}\mathbf{x}_{t-1}, \beta_t\mathbf{I}),
q(\mathbf{x}_{1:T}|\mathbf{x}_0) = \prod_{t=1}^T q(\mathbf{x}_t|\mathbf{x}_{t-1})
$$
</div>

上述过程一个很好的特性是，根据前向加噪过程和noise schedule，我们可以通过重参数化技巧得到任意时间步下的加噪结果 $ x_T \sim q(x_T ｜ x_0) $，这里定义  $\alpha_t = 1 - \beta_t$ 和 $\bar{\alpha_t} = \prod_{i=1}^t \alpha_i\$，那么有：

<div>
$$
\begin{aligned}
\mathbf{x}_t
&= \sqrt{\alpha_t}\mathbf{x}_{t-1} + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1} & \text{ ;where } \boldsymbol{\epsilon}_{t-1}, \boldsymbol{\epsilon}_{t-2}, \dots \sim \mathcal{N}(\mathbf{0}, \mathbf{I}) \\
&= \sqrt{\alpha_t \alpha_{t-1}} \mathbf{x}_{t-2} + \sqrt{1 - \alpha_t \alpha_{t-1}} \bar{\boldsymbol{\epsilon}}_{t-2} & \text{ ;where } \bar{\boldsymbol{\epsilon}}_{t-2} \text{ merges two Gaussians (*).} \\
&= \dots \\
&= \sqrt{\bar{\alpha}_t}\mathbf{x}_0 + \sqrt{1 - \bar{\alpha}_t}\boldsymbol{\epsilon} 
\end{aligned}
$$
</div>


上述推到过程利用了两个方差不同的高斯分布 $\mathcal{N}(\mathbf{0},\sigma_1^2\mathbf{I})$ 和 $\mathcal{N}(\mathbf{0},\sigma_2^2\mathbf{I})$ 相加等于一个新的高斯分布。重参数化后可得：

<div>
$$
q(\mathbf{x}_t \vert \mathbf{x}_0) = \mathcal{N}(\mathbf{x}_t; \sqrt{\bar{\alpha}_t} \mathbf{x}_0, (1 - \bar{\alpha}_t)\mathbf{I})
$$
</div>

扩散过程的这个特性很重要，通过上式我们可以额将 $x_T$ 看作是原始数据$x_0$ 和 随机噪声 $\boldsymbol{\epsilon}$ 的线性组合，其中两者的系数 $\sqrt{\bar{\alpha}_t}$ 和 $\sqrt{1 - \bar{\alpha}_t}$的平方和为1，我们也可以两部分系数为singal rate 和noise rate。通常的在前向加噪过程的 noise schedule中， $\beta_1 < \beta_2 < ... <  \beta_T$ ，因此 $\bar{\alpha}_1 > \bar{\alpha}_2 > ... > \bar{\alpha}_T$。

<img src="https://i.postimg.cc/Gtj2qf4c/image.png" alt="前向加噪示意图" style="width: 600px; height: auto;">


### 反向去噪过程
TBD
